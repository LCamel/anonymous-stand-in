
<script src="./bundle.js">
// npx browserify -r circomlibjs -r @zk-kit/incremental-merkle-tree -r ethers > web/bundle.js
</script>

<script>
"use strict";
const { ethers, Wallet, BigNumber } = require("ethers");
const { generateProof, SessionInfo, ASI } = require("asi");


const userPrivKeys = [
    "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80",
    "0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d",
    "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a",
    "0x7c852118294e51e653712a81e05800f419141751be58f605c371e15141b007a6",
    "0x47e179ec197488593b187f80a00eb0da91f1b9d0b13f8733639f19c30a34926a",
    ];
const asiPrivKeys = [
    "0x8b3a350cf5c34c9194ca85829a2df0ec3153be0318b5e2d3348e872092edffba",
    "0x92db14e403b83dfe3df233f83dfa3a0d7096f21ca9b0d6d6b8d88b2b4ec1564e",
    "0x4bbbf85ce3377467afe5d46f804f221813b2bb87f24d81f60f1fcdbf7cbf4356",
    "0xdbda1821b80551c9d65939329250298aa3472ba22feea921c0cf5d620ea67b97",
    "0x2a871d0798f97d79848a013d4936a73bf4cc922c825d33c1cf7073dff6d409c6",
    ];

const provider = new ethers.providers.JsonRpcProvider(); // local
const userSigners = userPrivKeys.map((key) => new Wallet(key, provider));
const asiSigners = asiPrivKeys.map((key) => new Wallet(key, provider));
const userAddrs = userPrivKeys.map((key) => ethers.utils.computeAddress(key));
const userAddress = "0x70997970C51812dc3A010C7d01b50e0d17dc79C8"; // TODO;
const asi = new ASI(ASI.TEMP_ADDR, userAddress, userSigners[1], asiSigners[1]);

// throws exception if the userTreeRoot is wrong
function parse() {
    return SessionInfo.parse(document.getElementById("ta").value);
}

async function create() {
    console.log("creating session...")
    const sessionInfo = parse();
    const tx = await asi.createSession(sessionInfo.sessionId, sessionInfo.getUserTreeRoot());
    const receipt = await tx.wait();
    console.log("createSession: ", receipt);
}
// https://stackoverflow.com/a/69132762
(()=>{
  const console_log = window.console.log;
  window.console.log = function(...args){
    console_log(...args);
    var textarea = document.getElementById('console_ta');
    if(!textarea) return;
    if (args.length == 1 && typeof(args[0]) == 'string') {
        textarea.value += args[0] + "\n";
    } else {
        args.forEach(arg=>textarea.value += `${JSON.stringify(arg, undefined, 4)}\n`);
    }
    textarea.scrollTop = textarea.scrollHeight;
  }
})();
function eq(a, b) {
    return BigNumber.from(a).eq(BigNumber.from(b));
}
function toHex(a) {
    return BigNumber.from(a).toHexString();
}

async function verifyWithTheContract() {
    const sessionInfo = parse();
    const userTreeRoot = await asi.getUserTreeRoot(sessionInfo.sessionId);
    console.log("The user tree root from the contract:\n" + toHex(userTreeRoot));
    if (! eq(sessionInfo.getUserTreeRoot(), userTreeRoot)) {
        console.log("Two roots don't match!!");
    } else {
        console.log("Two user tree roots do match.");
    }
}
async function register() {
    try {
    const sessionId = parse().sessionId;

    const question = await asi.getOpinionatedQuestion(sessionId);
    console.log("question: " + question);

    console.log("going to register()...");
    const tx = await asi.register(sessionId, question);
    const receipt = await tx.wait();
    console.log("register: ", receipt);
    } catch (ex) {
        console.log(ex.stack);
    }
}

async function proof() {
    const sessionInfo = parse();
    const userAddr = await userSigners[1].getAddress(); // TODO
    const userAddresses = sessionInfo.getUserAddresses();
    const secret = await asi.getOpinionatedSecret(sessionInfo.sessionId);
    const questions = await asi.getQuestions(sessionInfo.sessionId);

    console.log("generating proof...");
    const proofAndPublicSignals = await generateProof(userAddr, userAddresses, secret, questions, "./anonymous_stand_in.wasm", "./anonymous_stand_in_0001.zkey");

    console.log("calling proof()...");
    const tx = await asi.proof(sessionInfo.sessionId, proofAndPublicSignals);
    const receipt = await tx.wait();
    console.log("proof: ", receipt);
}

</script>


<style>
* {
    font-family: 'Courier New', monospace;
    font-weight: bold;
}
#chatroom {
    width: 100%;
    table-layout: fixed;
    word-wrap:break-word
}
#chatroom td:nth-child(1) {
    width: 4em;
    vertical-align: top;
}
#wrapper {
    overflow: scroll;
    height: 70%
}
</style>
<textarea id="ta" rows="13" style="width: 100%">
{
    "sessionId": "0x323e2f9e07db0fc7423d9f978d3597b7074fda78e4f74d2cea261d468c7731d0",
    "users": [
        [ "B",
          "0x70997970C51812dc3A010C7d01b50e0d17dc79C8" ],
        [ "C",
          "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC" ],
        [ "A",
          "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266" ]
    ],
    "root": "0x1839a18dfd8c995979d539fede89d2edc9f0b671c549e5f735afe5f82ab7b734"
}
</textarea>

<br/>
<input type="button" value="Verify content" onclick="parse(); console.log('OK')"/>
<br/>
<input type="button" value="Create with B" onclick="create()"/>
<br/>
<input type="button" value="Verify with the contract" onclick="verifyWithTheContract()"/><br/>

<input type="button" value="Register with b" onclick="register()"/>
<input type="text" id="secret" value="secret here"/>
<input type="button" value="Proof with B" onclick="proof()"/>
<br/>

<textarea id="console_ta" rows="13" style="width: 100%">
</textarea>
