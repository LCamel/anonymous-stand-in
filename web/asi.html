
<script src="./bundle.js">
// npx browserify -r circomlibjs -r @zk-kit/incremental-merkle-tree -r ethers > web/bundle.js
</script>

<script>
"use strict";
const { ethers, Wallet, BigNumber } = require("ethers");
const { generateProof, SessionInfo, User, ASI, SampleAccounts, TEMP_ADDR } = require("asi");


const provider = new ethers.providers.JsonRpcProvider(); // local
const userSigners = SampleAccounts.userPrivateKeys.map((key) => new Wallet(key, provider));
const asiSigners = SampleAccounts.asiPrivateKeys.map((key) => new Wallet(key, provider));
const userAddress = SampleAccounts.userAddresses[1];
const user = new User(TEMP_ADDR, userAddress, userSigners[1]);
const asi = new ASI(TEMP_ADDR, userAddress, asiSigners[1]);

// https://stackoverflow.com/a/69132762
(()=>{
  const console_log = window.console.log;
  window.console.log = function(...args){
    console_log(...args);
    var textarea = document.getElementById('console_ta');
    if(!textarea) return;
    if (args.length == 1 && typeof(args[0]) == 'string') {
        textarea.value += args[0] + "\n";
    } else {
        args.forEach(arg=>textarea.value += `${JSON.stringify(arg, undefined, 4)}\n`);
    }
    textarea.scrollTop = textarea.scrollHeight;
  }
})();

// throws exception if the userTreeRoot is wrong
function parse() {
    return SessionInfo.parse(document.getElementById("ta").value);
}

async function create() {
    console.log("calling createSession()...");
    const sessionInfo = parse();
    const tx = await user.createSession(sessionInfo.sessionId, sessionInfo.getUserTreeRoot());
    const receipt = await tx.wait();
    console.log("createSession: ", receipt);
}

function eq(a, b) {
    return BigNumber.from(a).eq(BigNumber.from(b));
}

function toHex(a) {
    return BigNumber.from(a).toHexString();
}

async function verifyWithTheContract() {
    const sessionInfo = parse();
    console.log("calling getUserTreeRoot()...");
    const userTreeRoot = await user.getUserTreeRoot(sessionInfo.sessionId);
    console.log("The user tree root from the contract:\n" + toHex(userTreeRoot));
    if (! eq(sessionInfo.getUserTreeRoot(), userTreeRoot)) {
        console.log("Two roots don't match!!");
    } else {
        console.log("Two user tree roots do match.");
    }
}
async function register() {
    try {
    const sessionId = parse().sessionId;

    const question = await asi.getOpinionatedQuestion(sessionId);
    console.log("question: " + question);

    console.log("calling register()...");
    const tx = await asi.register(sessionId, question);
    const receipt = await tx.wait();
    console.log("register: ", receipt);
    } catch (ex) {
        console.log(ex.stack);
    }
}

async function proof() {
    const sessionInfo = parse();
    //const userAddress // globally defined
    const userAddresses = sessionInfo.getUserAddresses();
    const secret = await asi.getOpinionatedSecret(sessionInfo.sessionId);
    const questions = await user.getQuestions(sessionInfo.sessionId);

    console.log("generating proof...");
    const proofAndPublicSignals = await generateProof(userAddress, userAddresses, secret, questions, "./anonymous_stand_in.wasm", "./anonymous_stand_in_0001.zkey");

    console.log("calling proof()...");
    const tx = await user.proof(sessionInfo.sessionId, proofAndPublicSignals);
    const receipt = await tx.wait();
    console.log("proof: ", receipt);
}

</script>


<style>
* {
    font-family: 'Courier New', monospace;
    font-weight: bold;
}
#chatroom {
    width: 100%;
    table-layout: fixed;
    word-wrap:break-word
}
#chatroom td:nth-child(1) {
    width: 4em;
    vertical-align: top;
}
#wrapper {
    overflow: scroll;
    height: 70%
}
</style>
<textarea id="ta" rows="13" style="width: 100%">
{
    "sessionId": "0x323e2f9e07db0fc7423d9f978d3597b7074fda78e4f74d2cea261d468c7731d0",
    "users": [
        [ "B",
          "0x70997970C51812dc3A010C7d01b50e0d17dc79C8" ],
        [ "C",
          "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC" ],
        [ "A",
          "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266" ]
    ],
    "root": "0x1839a18dfd8c995979d539fede89d2edc9f0b671c549e5f735afe5f82ab7b734"
}
</textarea>

<br/>
<input type="button" value="Verify content" onclick="parse(); console.log('OK')"/>
<br/>
<input type="button" value="Create with B" onclick="create()"/>
<br/>
<input type="button" value="Verify with the contract" onclick="verifyWithTheContract()"/><br/>

<input type="button" value="Register with b" onclick="register()"/>
<input type="text" id="secret" value="secret here"/>
<input type="button" value="Proof with B" onclick="proof()"/>
<br/>

<textarea id="console_ta" rows="13" style="width: 100%">
</textarea>
