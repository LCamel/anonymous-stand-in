<html>
<head>
<script src="./bundle.js">
// npx browserify -r circomlibjs -r @zk-kit/incremental-merkle-tree -r ethers > web/bundle.js
</script>

<script>
"use strict";
const { ethers, Wallet, BigNumber } = require("ethers");
const { SessionInfo, UserSide, ASISide, SampleAccounts, TEMP_ADDR, Proof } = require("asi");


const provider = new ethers.providers.JsonRpcProvider(); // local
const userSigners = SampleAccounts.userPrivateKeys.map((key) => new Wallet(key, provider));
const asiSigners = SampleAccounts.asiPrivateKeys.map((key) => new Wallet(key, provider));
const userAddresses = SampleAccounts.userAddresses;
const userSides = userSigners.map((s, i) => new UserSide(TEMP_ADDR, userAddresses[i], s));
const asiSides = asiSigners.map((s, i) => new ASISide(TEMP_ADDR, userAddresses[i], s));

// throws exception if the userTreeRoot is wrong
function parse() {
    return SessionInfo.parse(document.getElementById("ta").value);
}

async function create(I) {
    const userSide = userSides[I];
    console.log("calling createSession()...");
    const { sessionId, userTreeRoot } = parse();
    const tx = await userSide.createSession(sessionId, userTreeRoot);
    const receipt = await tx.wait();
    console.log("createSession: ");
    showReceipt(receipt);
}

function eq(a, b) {
    return BigNumber.from(a).eq(BigNumber.from(b));
}

function toHex(a) {
    return BigNumber.from(a).toHexString();
}

async function verify(I) {
    try {
    const userSide = userSides[I]; // TODO: 1. extract to lib 2. provider
    const sessionInfo = parse();
    console.log("Parse OK");
    if (!sessionInfo.sessionId) {
        console.log("[Invalid] empty sessionId.");
        return;
    }
    console.log("calling getUserTreeRoot()...");
    const contractUserTreeRoot = await userSide.getUserTreeRoot(sessionInfo.sessionId);
    console.log("The user tree root from the contract:\n" + toHex(contractUserTreeRoot));
    if (eq(contractUserTreeRoot, 0n)) {
        console.log("[OK] No existing session. You can create the session.");
    } else {
        if (eq(contractUserTreeRoot, sessionInfo.userTreeRoot)) {
            console.log("[OK] User tree roots are equal. You can call register() or proof().");
        } else {
            console.log("[Invalid] User tree roots are NOT equal. Don't call register() or proof()");
        }
    }
    } catch (e) {
        console.error("[Invalid] " + e);
    }
}

async function register(I) {
    try {
    const asiSide = asiSides[I];
    const { sessionId } = parse();
    const secret = await asiSide.getOpinionatedSecret(sessionId);
    document.getElementById(`secret${I}`).value = secret; // pass to the userSide
    const question = asiSide.getQuestion(secret);
    console.log("question: " + question);

    console.log("calling register()...");
    const tx = await asiSide.register(sessionId, question);
    const receipt = await tx.wait();
    console.log("register: ");
    showReceipt(receipt);
    } catch (ex) {
        console.log(ex.stack);
    }
}

async function proof(I) {
    const userSide = userSides[I];
    const { sessionId, userAddresses } = parse();
    const secret = BigInt(document.getElementById(`secret${I}`).value);
    const questions = await userSide.getQuestions(sessionId);

    console.log("generating proof...");
    const proofAndPublicSignals = await Proof.generateProof(userSide.userAddress, userAddresses, secret, questions, "./anonymous_stand_in.wasm", "./anonymous_stand_in_0001.zkey");

    console.log("calling proof()...");
    const tx = await userSide.proof(sessionId, proofAndPublicSignals);
    const receipt = await tx.wait();
    console.log("proof: ");
    showReceipt(receipt);
}
function showReceipt(receipt) {
    //console.log(JSON.stringify(receipt, undefined, 4));
    console.log(receipt);
}

</script>


<style>
* {
    font-family: 'Courier New', monospace;
    font-weight: bold;
}
</style>

</head>
<body>

<textarea id="ta" rows="13" style="width: 100%">
{
    "sessionId": "0x323e2f9e07db0fc7423d9f978d3597b7074fda78e4f74d2cea261d468c7731d0",
    "users": [
        [ "B",
          "0x70997970C51812dc3A010C7d01b50e0d17dc79C8" ],
        [ "C",
          "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC" ],
        [ "A",
          "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266" ]
    ],
    "root": "0x1839a18dfd8c995979d539fede89d2edc9f0b671c549e5f735afe5f82ab7b734"
}
</textarea>

<div id="all">
<div>
{NAME}
<input type="button" value="Verify" onclick="verify({I})"/>
<input type="button" value="Create" onclick="create({I})"/>
<input type="button" value="Register" onclick="register({I})"/>
<input type="text" id="secret{I}" value="secret here"/>
<input type="button" value="Proof" onclick="proof({I})"/>
</div>
</div>
<script>
    const parent = document.getElementById("all");
    const html = parent.innerHTML;
    parent.innerHTML = "";
    for (let I = 0; I < 5; I++) {
        parent.innerHTML += html.replaceAll("{NAME}", "ABCDE".charAt(I)).replaceAll("{I}", I);
    }
</script>

<!-- console visualization; see http://meta.stackexchange.com/a/242491 -->
<script src="https://gh-canon.github.io/stack-snippet-console/console.min.js"></script>

</body>
</html>